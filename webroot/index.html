<!DOCTYPE html>
<html>
  <head>
    <script src="/resources/jquery.js"></script>
    <script src="/resources/jquery.svg.js"></script>
    <script src="/resources/jquery.svgdom.js"></script>
    <link rel="stylesheet" href="/resources/styles.css">
  </head>
<body>


<nav id="control">
  <button id="park">Park</button>
  <button id="movefirst">Move to First point</button>
  <button id="draw">Draw Path</button>
  <button id="stop">STOP draw</button>
  <button id="pen-up">Brush Up</button>
  <button id="pen-down">Brush Down</button>
  <button id="disable">Unlock/Disable Motors</button>
</nav>

<nav id="tools">
  <a id="water0" class="water" href="#">Water 1</a>
  <a id="water1" class="water" href="#">Water 2</a>
  <a id="water2" class="water" href="#">Water 3</a>
  <a id="color0" class="color colorset1" href="#">Brown</a>
  <a id="color1" class="color colorset1" href="#">Violet</a>
  <a id="color2" class="color colorset1" href="#">Blue</a>
  <a id="color3" class="color colorset1" href="#">Green</a>
  <a id="color4" class="color colorset1" href="#">Yellow</a>
  <a id="color5" class="color colorset1" href="#">Orange</a>
  <a id="color6" class="color colorset1" href="#">Red</a>
  <a id="color7" class="color colorset1" href="#">Black</a>
</nav>

<nav id="paths"><ul></ul></nav>

<svg id="main" xmlns="http://www.w3.org/2000/svg" version="1.1" height="738" width="1000">
  <g
     id="layer1"
     transform="translate(940.5858422,8.78524) rotate(90) scale(0.95)">
    <g
       id="g6432"
       transform="matrix(10.332556,0,0,10.332556,-5145.7248,-8136.77)">
      <path
         d="m 563.483,829.094 c 0,-3.943 2.252,-6.484 2.252,-11.663 0,-4.732 -2.071,-8.484 -1.67,-11.133 0.401,-2.649 3.712,-4.082 3.712,-4.082 l -6.123,-7.053 c 0,0 -2.65,5.195 -5.993,5.195 -2.779,0 -4.967,-2.879 -7.817,-3.307 -3.815,-0.573 -9.386,2.751 -9.386,2.751 0,0 8.114,-5.592 4.452,-7.423 -2.968,-1.484 -7.051,7.161 -7.051,7.161 0,0 1.861,-9.943 -1.49,-9.943 -3.353,0 -0.737,9.798 -0.737,9.798 0,0 -4.265,-8.501 -7.237,-6.831 -2.823,1.59 5.567,7.268 5.567,7.268 0,0 -7.297,-3.306 -10.631,-3.163 -4.646,0.201 -3.951,2.761 -8.201,2.761 -2.86,0 -4.028,-5.595 -4.028,-5.595 l -9.704,8.748 c 0,0 4.431,1.884 5.205,4.271 1.566,4.823 -2.331,6.691 -2.331,10.393 0,6.31 2.97,8.947 2.97,12.246 0,3.46 -6.497,6.124 -6.497,6.124 0,0 7.193,2.007 7.193,5.012 0,4.267 -3.479,5.905 -3.479,10.577 0,5.752 3.896,5.379 3.188,9.647 -0.428,2.583 -5.973,6.867 -5.973,6.867 l 8.688,8.673 c 0,0 2.827,-4.205 5.786,-4.205 2.97,0 5.283,2.583 8.164,2.583 3.337,0 5.214,-2.596 7.795,-2.596 3.335,0 5.382,5.382 5.382,5.382 0,0 1.38,-5.514 6.309,-5.514 1.521,0 3.711,2.356 6.865,2.356 3.155,0 4.863,-2.648 7.609,-2.648 2.41,0 4.921,4.642 4.921,4.642 l 8.255,-7.932 c 0,0 -5.383,-2.226 -5.383,-5.009 0,-3.104 1.856,-4.454 1.856,-10.577 0,-7.237 -2.15,-8.051 -2.15,-13.102 0,-2.261 5.104,-4.143 5.104,-4.143 0,0 -5.392,-0.815 -5.392,-6.536 z"
         id="frame"
         inkscape:connector-curvature="0"
         style="fill:#665440" />
      <polygon
         points="560.964,803.779 507.902,802.554 508.722,868.837 560.964,868.02 "
         id="polygon480"
         style="fill:#ffeb8c" />
      <polygon
         points="560.215,804.763 508.788,803.603 509.562,867.788 560.215,867.017 "
         id="polygon482"
         style="fill:#c7a941" />
      <polygon
         points="560.215,832.603 509.139,832.603 509.562,867.788 560.215,867.017 "
         id="polygon484"
         style="fill:#824830" />
      <path
         d="m 509.139,832.603 h 51.076 v -4.743 c 0,0 -2.369,3.197 -4.058,3.197 -2.322,0 -4.1,-4.931 -6.573,-4.931 -2.475,0 -5.22,5.896 -5.22,5.896 l -19.143,-0.774 c 0,0 -3.673,-9.278 -5.8,-9.278 -1.161,0 -3.285,4.64 -3.285,4.64 0,0 -3.094,-8.121 -4.642,-8.121 -0.854,0 -1.802,2.128 -2.479,4.032 l 0.124,10.082 z"
         id="path486"
         inkscape:connector-curvature="0"
         style="fill:#596b30" />
      <path
         d="m 514.588,832.964 c 0,0 -4.903,0.22 -4.903,1.765 0,1.546 5.969,0.82 5.969,2.37 0,1.545 -4.435,1.4 -4.424,2.754 0.024,2.682 10.247,1.062 10.247,1.062 0,0 -7.734,-0.676 -7.734,-1.642 0,-0.968 4.179,-1.233 4.179,-2.394 0,-1.306 -6.98,-1.135 -6.98,-2.15 -0.002,-1.114 3.646,-1.765 3.646,-1.765 z"
         id="path488"
         inkscape:connector-curvature="0"
         style="fill:#433225" />
      <path
         d="m 554.988,833.559 c 0,0 -2.554,0.113 -2.554,0.918 0,0.807 3.107,0.428 3.107,1.234 0,0.804 -2.309,0.729 -2.302,1.432 0.012,1.395 5.333,0.553 5.333,0.553 0,0 -4.023,-0.351 -4.023,-0.853 0,-0.505 2.174,-0.644 2.174,-1.245 0,-0.68 -3.634,-0.592 -3.634,-1.121 10e-4,-0.576 1.899,-0.918 1.899,-0.918 z"
         id="path490"
         inkscape:connector-curvature="0"
         style="fill:#433225" />
      <path
         d="m 521.378,844.216 c 0,0 6.644,-2.708 2.466,-9.945 -2.987,-5.176 0,-12.663 0,-12.663 0,0 -0.358,-5.733 1.529,-8.63 2.09,-3.2 4.734,-5.012 8.578,-5.012 8.848,0 12.021,4.701 12.021,16.885 0,12.354 2.507,16.101 2.507,16.101 l -27.101,3.264 z"
         id="path492"
         inkscape:connector-curvature="0"
         style="fill:#433225" />
      <path
         d="m 551.956,865.953 v -4.893 c 7.623,-4.737 1.306,-12.882 -1.368,-16.177 -5.006,-6.175 -13.522,-7.414 -13.522,-13.256 0,-5.343 4.453,-9.187 1.671,-16.146 -1,-2.497 -7.516,-4.592 -7.516,-4.592 l -4.037,2.228 c -1.529,0.974 -2.202,9.183 0.418,12.944 2.133,3.062 4.038,3.248 4.038,3.248 v 5.239 c 0,0 -5.985,2.923 -11.598,9.498 -4.994,5.854 -7.204,18.979 -7.453,22.861 l 39.367,-0.954 z"
         id="path494"
         inkscape:connector-curvature="0"
         style="fill:#f4d37e" />
      <path
         d="m 559.088,867.035 c -0.147,-1.987 -0.645,-8.715 -2.26,-13.557 -2.028,-6.089 -4.85,-9.744 -10.717,-14.476 0,0 -5.01,7.794 -15.03,7.794 -4.355,0 -7.375,-4.87 -5.708,-8.629 -0.895,0.796 -4.452,4.888 -5.331,5.88 -4.603,5.227 -7.542,14.581 -7.542,23.703 l 46.588,-0.715 z"
         id="path496"
         inkscape:connector-curvature="0"
         style="fill:#433225" />
      <path
         d="m 520.96,844.801 0.011,14.108 c 0,0 4.774,-1.277 10.053,-0.208 0,0 -2.322,1.74 -4.062,4.206 -1.489,2.109 -2.175,4.351 -2.175,4.351"
         id="path498"
         inkscape:connector-curvature="0"
         style="fill:none;stroke:#000000;stroke-width:0.55669999" />
      <path
         d="m 548.229,843.913 c 0,0 -0.771,2.128 -1.74,7.637 -0.693,3.949 -0.822,8.618 -0.822,8.618"
         id="path500"
         inkscape:connector-curvature="0"
         style="fill:none;stroke:#000000;stroke-width:0.55669999" />
      <path
         d="m 529.758,824.797 c 0,0 0.827,0.803 1.74,0.772 1.169,-0.033 1.781,-0.767 1.781,-0.767"
         id="path502"
         inkscape:connector-curvature="0"
         style="fill:none;stroke:#000000;stroke-width:0.41339999;stroke-linecap:round" />
      <path
         d="m 533.143,818.099 c 0.518,-0.404 1.169,-0.635 1.831,-0.585 0.641,0.051 1.16,0.349 1.492,0.799"
         id="path504"
         inkscape:connector-curvature="0"
         style="fill:none;stroke:#000000;stroke-width:0.28490001;stroke-linecap:round" />
      <path
         d="m 552.774,863.827 c 0,0 -2.819,-2.301 -6.882,-2.825 -3.221,-0.419 -8.007,-0.282 -11.053,0.347 -3.652,0.75 -4.834,1.935 -4.834,1.935"
         id="path506"
         inkscape:connector-curvature="0"
         style="fill:none;stroke:#000000;stroke-width:0.41819999" />
      <path
         d="m 546.524,859.932 c 0,0 1.748,-0.375 3.566,-0.377 1.698,-0.007 3.409,0.446 3.409,0.446"
         id="path508"
         inkscape:connector-curvature="0"
         style="fill:none;stroke:#000000;stroke-width:0.55669999" />
      <path
         d="m 538.129,861.963 c 0,0 -0.743,-2.492 -3.701,-2.827 -3.027,-0.343 -8.312,4.907 -6.274,6.235 3.551,2.324 9.975,-3.408 9.975,-3.408 z"
         id="path510"
         inkscape:connector-curvature="0"
         style="fill:#f5c14c" />
      <line
         x1="534.315"
         y1="862.97998"
         x2="530.328"
         y2="865.44397"
         id="line512"
         style="fill:none;stroke:#000000;stroke-width:0.28999999;stroke-linecap:round" />
      <line
         x1="531.70502"
         y1="861.31097"
         x2="528.008"
         y2="864.06897"
         id="line514"
         style="fill:none;stroke:#000000;stroke-width:0.28999999;stroke-linecap:round" />
      <line
         x1="533.51599"
         y1="861.74902"
         x2="528.80499"
         y2="865.08301"
         id="line516"
         style="fill:none;stroke:#000000;stroke-width:0.28999999;stroke-linecap:round" />
      <path
         d="m 529.853,860.634 c 0,0 0.735,-1.933 4.229,-2.006 3.049,-0.062 8.69,5.125 6.653,6.454 -3.551,2.321 -10.882,-4.448 -10.882,-4.448 z"
         id="path518"
         inkscape:connector-curvature="0"
         style="fill:#f5df88" />
      <line
         x1="534.57501"
         y1="862.68903"
         x2="538.56097"
         y2="865.15601"
         id="line520"
         style="fill:none;stroke:#000000;stroke-width:0.35049999;stroke-linecap:round" />
      <line
         x1="537.18402"
         y1="861.02301"
         x2="540.883"
         y2="863.77698"
         id="line522"
         style="fill:none;stroke:#000000;stroke-width:0.35049999;stroke-linecap:round" />
      <line
         x1="535.37299"
         y1="861.45697"
         x2="540.08398"
         y2="864.79102"
         id="line524"
         style="fill:none;stroke:#000000;stroke-width:0.35049999;stroke-linecap:round" />
      <line
         x1="535.70502"
         y1="865.10797"
         x2="537.14398"
         y2="867.08398"
         id="line526"
         style="fill:none;stroke:#8a4d4a;stroke-width:0.35049999;stroke-linecap:round" />
      <path
         d="m 527.114,818.174 c 0,0 1.322,-0.743 2.575,-0.381 1.533,0.442 1.347,1.725 1.347,2.516 0,1.343 -1,2.713 -1,2.713 0,0 0.406,0.137 1.178,0.137 0.771,0 1.169,-0.091 1.169,-0.091"
         id="path528"
         inkscape:connector-curvature="0"
         style="fill:none;stroke:#000000;stroke-width:0.28490001;stroke-linecap:round" />
      <line
         x1="529.19"
         y1="818.44202"
         x2="529.19"
         y2="819.39099"
         id="line530"
         style="fill:none;stroke:#000000;stroke-width:0.55669999;stroke-linecap:round" />
      <line
         x1="534.93298"
         y1="818.44202"
         x2="534.93298"
         y2="819.39099"
         id="line532"
         style="fill:none;stroke:#000000;stroke-width:0.55669999;stroke-linecap:round" />
      <path
         d="m 547.735,841.183 -8.164,4.27 c 5.429,-5.891 0.695,-8.954 0.695,-8.954 l 5.149,-3.759 2.32,8.443 z"
         id="path534"
         inkscape:connector-curvature="0"
         style="fill:#433225" />
      <path
         d="m 548.479,840.952 c 0,0 -3.709,0.419 -8.907,4.501 -5.81,4.566 -8.907,11.133 -8.907,11.133"
         id="path536"
         inkscape:connector-curvature="0"
         style="fill:none;stroke:#000000;stroke-width:0.55669999;stroke-linecap:round" />
    </g>
  </g>

  <line
         x1="2"
         y1="2"
         x2="3"
         y2="2"
         id="drawpoint"
         style="fill:none;stroke:red;stroke-width:5;stroke-linecap:round" />
</svg>


<script>

  var $path = {};
  var index = 1;
  var penStat = {};
  var $svg = $('#main');
  var height = $svg.height();
  var width = $svg.width();
  var stopDraw = false;
  var precision = 1;
  var svgOffset = $svg.offset();

  // Convert the polys and lines to path
  // TODO: This happens after load, or before print... :|
  changeToPaths();

  // Get initial pen data from machine
  setPenStat();

  // Bind all SVG element click / select
  $('svg *:not(g)').on('click', function(e){
    if ($path.length) {
      $path.removeClass('selected');
    }
    $path = $(this);
    $path.addClass('selected');
    $path.transformMatrix = this.getTransformToElement(this.ownerSVGElement);
    index = 0;

    console.log($path);

    e.stopPropagation(); // Don't bubble up and select groups
  });

  // Bind to Tool Change nav items
  $('nav#tools a').click(function(e){
    changeTool(this.id);
  });

  // Bind to control buttons
  $('#park').click(function(){ parkPen(); });
  $('#movefirst').click(function(){ readyFirstPoint(); });
  $('#draw').click(function(){ drawNextPoint(); });
  $('#stop').click(function(){ stopDraw = true; });
  $('#pen-up').click(function(){ penUp() });
  $('#pen-down').click(function(){ penDown(); });
  $('#disable').click(function(){ disableMotors(); });

  // Convert everything to paths
  function changeToPaths() {
    var polys = document.querySelectorAll('polygon,polyline');
    [].forEach.call(polys, convertPolyToPath);

    var lines = document.querySelectorAll('line');
    [].forEach.call(lines, convertLineToPath);

    function convertPolyToPath(poly){
      var svgNS = poly.ownerSVGElement.namespaceURI;
      var path = document.createElementNS(svgNS,'path');
      var points = poly.getAttribute('points').split(/\s+|,/);
      var x0=points.shift(), y0=points.shift();
      var pathdata = 'M'+x0+','+y0+'L'+points.join(' ');
      if (poly.tagName=='polygon') {
        pathdata+='z';
      }

      path.setAttribute('d',pathdata);

      path.setAttribute('style', poly.style.cssText);
      path.setAttribute('id', poly.id);
      poly.parentNode.replaceChild(path,poly);
    }

    function convertLineToPath(line){
      // Don't convert our drawpoint
      // TODO: Add the point after load or something to avoid this :P
      if (line.id == 'drawpoint'){
        return;
      }
      var svgNS = line.ownerSVGElement.namespaceURI;
      var path = document.createElementNS(svgNS,'path');
      path.setAttribute('d', 'M'+
        line.getAttribute('x1')+','+
        line.getAttribute('y1')+' L'+
        line.getAttribute('x2')+','+
        line.getAttribute('y2'));
      path.setAttribute('style', line.style.cssText);
      path.setAttribute('id', line.id);
      line.parentNode.replaceChild(path, line);
    }
  }

  function readyFirstPoint() {
    moveTo($path[0].getPointAtLength(0).matrixTransform($path.transformMatrix));
  }

  function drawNextPoint(){
    if (stopDraw) {
      stopDraw = false;
      penUp();
      return;
    }

    index+= precision;
    if (index > $path[0].getTotalLength()) {
      console.log('Path Complete!');
      index = 0;
      penUp();
      return;
    }

    var point = $path[0].getPointAtLength(index).matrixTransform($path.transformMatrix);
    point.ignoreTimeout = 1;

    // With each coordinate, check to see that the path is visible
    $('#drawpoint').hide()
    var coordPath = document.elementFromPoint(point.x+svgOffset.left+2, point.y+svgOffset.top+2);
    $('#drawpoint').show()

    if (coordPath) {
      if (coordPath.id == $path[0].id){
        // Correct path
        console.log('Path Visible');

        // If Pen isn't down, put it down, then continue!
        if (penStat.state == 0){
          penDown(function(){
            moveTo(point, drawNextPoint);
          });
        } else{
          moveTo(point, drawNextPoint);
        }
      } else {
        // Wrong path!
        console.log('Path Hidden by ', coordPath.id);

        // If Pen is down, put it up, then continue!
        if (penStat.state == 1){
          penUp(function(){
            moveTo(point, drawNextPoint);
          });
        } else {
          moveTo(point, drawNextPoint);
        }
      }
    } else {
      console.log('Bad Point?: ', point);
      moveTo(point, drawNextPoint);
    }
  }

  // Get the pen x/y status
  function setPenStat(){
    $.ajax({
      url: '/pen',
      type: 'GET',
      success: function(d){
        penStat = d;
      }
    });
  }

  function penUp(callback){
    $.ajax({
      url: '/pen',
      type: 'PUT',
      data: { // 0 is off, don't draw
        state: 0
      },
      success: function(d){
        penStat = d;
        if (callback) callback();
      }
    });
  }

  function penDown(callback) {
    $.ajax({
      url: '/pen',
      type: 'PUT',
      data: { // 1 is on, do draw
        state: 1
      },
      success: function(d){
        penStat = d;
        if (callback) callback();
      }
    });
  }


  function moveTo(point, callback){
    // Move visible drawpoint
    $('#drawpoint').attr({
      x1:point.x-2,
      y1:point.y-2,
      x2:point.x+2,
      y2:point.y+2
    });

    $.ajax({
      url: '/pen',
      type: 'PUT',
      data: { // Send as percentage
        x: (point.x / width) * 100,
        y: (point.y / height) * 100,
        ignoreTimeout: point.ignoreTimeout
      },
      success: function(d){
        if (callback) callback();
      }
    });
  }

  function parkPen(callback){
    $.ajax({
      url: '/pen',
      type: 'DELETE',
      success: function(d){
        if (callback) callback();
      }
    });
  }

  function disableMotors(callback){
    $.ajax({
      url: '/motors',
      type: 'DELETE',
      success: function(d){
        if (callback) callback();
      }
    });
  }

  function changeTool(toolName, callback){
    $.ajax({
      url: '/tools/' + toolName,
      type: 'PUT',
      success: function(d){
        if (callback) callback();
      }
    });
  }

</script>

</body>
</html>

